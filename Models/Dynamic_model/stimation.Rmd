---
title: "Dynamic Model"
author: "Antonio Huerta Montellano"
date: \today
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
library(lmtest) # for robust standard errors
library(dplyr) # for group_by function
library(ggplot2) # for better plots
library(dplyr) # for data managment
library(clubSandwich) # Grouped errors
library(tidyr) # Datframes manipulation
library(lubridate)
library(plm)
```


## Exploración de los paneles

Importemos los paneles donde un pánel corresponde a los bateadores y, el otro, a los fielderos.

```{r import_panel}
setwd("~/Documentos/Github/Proyectos/MLB_HN/")
hitters_panel <- read.csv('ETL_Data/Panel/General/Dynamic_model/dynamic_model_hitter.csv')
fielders_panel <- read.csv('ETL_Data/Panel/General/Dynamic_model/dynamic_model_fielder.csv')
```
Por otro lado, se mostrarán las dimensiones de cada pánel
```{r panel_dimentions}
print("Bateadores: ")
print(dim(hitters_panel))
print("")
print("Fildeadores: ")
print(dim(fielders_panel))
```

Debido a que en las estadísticas descriptivas se observó un shock en el año de la pandemia COVID-19, se obtendrán las estimaciones quitando el año 2020.

```{r covid_filter, include=FALSE}
# filter out rows with year 2020
# Bateadores
hitters_panel_covid <- hitters_panel %>% 
                       filter(Anio_t != 2020)
# Fildeadores
fielders_panel_covid <- fielders_panel %>%
                        filter(Anio_t != 2020)
```



## Segmentación por grupo

Lo que haremos es dividir los paneles en ciertas categorías. Primero, veamos todas las posiciones en los páneles
```{r positions}
print("Bateadores:")
print(unique(hitters_panel$Posicion_t))
print("")
print("Fildeadores:")
print(unique(fielders_panel$Posicion_t))
```
Arriba se muestran las posiciones de los jugadores en nuestras bases de datos. A pesar de que en los bateadores aparezcan posiciones defensivas se debe a que estos juegan tanto como ofensivos como defensivos. Estando en la ofensiva se juega en las misma posición que todos por lo que no es necesario especificar que ocupala posición de bateador (**H**). Sin embargo, cuando se dice que es un bateador designado (**DH**) ya que este solo juega en la ofensiva para sustituir a un lanzador/pitcher.

Por otro lado, veamos cuantas observaciones hay por posición.

```{r positions_count_hitter}
hitters_panel %>% count(Posicion_t, sort = TRUE)
```

```{r positions_count_fielder}
fielders_panel %>% count(Posicion_t, sort = TRUE)
```


Continuemos con la segmentación de acuerdo a categorías. Primero, obtendremos el split de todas las posiciones y luego concatenaremos de acuerdo a los grupos de interés:

**Ofensivos:**

- **Bateador designado (DH).**
- **No bateador designado (H).**

Debido a la falta de observaciones para los _outfielders_ es que se omitirá su estimación. Por otro lado, debido a que la mayoría de los datos para los fildeadores son de los lanzadores, podemos agruparlos de la siguiente manera

**Defensivos:**

- **Starting pitcher:** Lanzador inicial (SP).
- **Relief pitcher:** Lanzador de relevo (RP) y lanzador de cierre (RP/CL)
- **Campo corto (SS).**


```{r position_split, include=FALSE}
# split the data frame by category
split_hitter <- split(hitters_panel,
                      f = hitters_panel$Posicion_t)
split_fielder <- split(fielders_panel,
                       f = fielders_panel$Posicion_t)

# COVID panels:
split_hitter_covid <- split(hitters_panel_covid,
                            f = hitters_panel_covid$Posicion_t)
split_fielder_covid <- split(fielders_panel_covid,
                             f = fielders_panel_covid$Posicion_t)
```

Segundo, crearemos las categorías de acuerdo a la especificación mencionada arriba
```{r group_category_split, include=FALSE}
# Whole panel:
# Offensive:
h_category_1 <- split_hitter[["SP"]]
h_category_2 <- split_hitter[["RP"]]
h_category_3 <- split_hitter[["RP/CL"]]
h_category_4 <- split_hitter[["C"]]
h_category_5 <- split_hitter[["1B"]]
h_category_6 <- split_hitter[["2B"]]
h_category_7 <- split_hitter[["3B"]]
h_category_8 <- split_hitter[["SS"]]
h_category_9 <- split_hitter[["RF"]]
h_category_10 <- split_hitter[["CF"]]
h_category_11 <- split_hitter[["LF"]]
d_hitter_data <- split_hitter[["DH"]]

# Defensive:
starting_data <- split_fielder[["SP"]]
b_category_2 <- split_fielder[["RP"]]
b_category_3 <- split_fielder[["RP/CL"]]
shorts_data <- split_fielder[["SS"]]

# COVID panel:
# Offensive:
cov_h_category_1 <- split_hitter_covid[["SP"]]
cov_h_category_2 <- split_hitter_covid[["RP"]]
cov_h_category_3 <- split_hitter_covid[["RP/CL"]]
cov_h_category_4 <- split_hitter_covid[["C"]]
cov_h_category_5 <- split_hitter_covid[["1B"]]
cov_h_category_6 <- split_hitter_covid[["2B"]]
cov_h_category_7 <- split_hitter_covid[["3B"]]
cov_h_category_8 <- split_hitter_covid[["SS"]]
cov_h_category_9 <- split_hitter_covid[["RF"]]
cov_h_category_10 <- split_hitter_covid[["CF"]]
cov_h_category_11 <- split_hitter_covid[["LF"]]
d_hitter_cov_data <- split_hitter_covid[["DH"]]

# Defensive:
starting_cov_data <- split_fielder_covid[["SP"]]
cov_b_category_2 <- split_fielder_covid[["RP"]]
cov_b_category_3 <- split_fielder_covid[["RP/CL"]]
shorts_cov_data <- split_fielder_covid[["SS"]]
```

Tercero, concatenaremos estas bases de datos de acuerdo a los grupos señalados anteriormente

```{r group_concat, include=FALSE}
# All panels:
# Hitters:
# Concatenate the two categories
hitter_data <- rbind(h_category_1, h_category_2, h_category_3, h_category_4,
                     h_category_5, h_category_6, h_category_7, h_category_8,
                     h_category_9, h_category_10, h_category_11)

# Fielders:
# Concatenate the two categories
relief_pitcher_data <- rbind(b_category_2, b_category_3)


# COVID filter:
# Hitters:
# Concatenate the two categories
hitter_cov_data <- rbind(cov_h_category_1, cov_h_category_2, cov_h_category_3, cov_h_category_4,
                         cov_h_category_5, cov_h_category_6, cov_h_category_7, cov_h_category_8,
                         cov_h_category_9, cov_h_category_10, cov_h_category_11)

# Fielders:
# Concatenate the two categories
relief_pitcher_cov_data <- rbind(cov_b_category_2, cov_b_category_3)
```

Veamos las dimensiones de cada una de los paneles sin el shock de la COVID-19:
```{r group_dimentions}
print("Regular hitter: ")
print(dim(hitter_cov_data))
print("")
print("Designated hitter: ")
print(dim(d_hitter_cov_data))
print("")
print("Relief pitchers: ")
print(dim(relief_pitcher_cov_data))
print("")
print("Starting pitchers: ")
print(dim(starting_cov_data))
print("")
print("Short stops: ")
print(dim(shorts_cov_data))
```


## Estimaciones y regresiones

Lo que resta hacer es implementar un algoritmo donde se pueda hacer el siguiente modelo para todas las estadísticas deportiva de acuerdo a si el jugador es defensivo u ofensivo:

$$
Y_{t}(\cdot) = \alpha + \beta_{0}X_{t} + \beta_{1}\text{Controles}_{t} + u_{t}
$$

donde

- $Controles_{t}$:
    - Equipo.
    - Edad.
    - Año.
- $\alpha$: Heterogeneidad del jugador.

Creemos la lista de variables sobre las cuáles se va a iterar el clico
```{r var_list, include=FALSE}
# LIsta de variables acumuladas y anualmente promediadas_
cum_hitter <- list("X_At_bats_t_1", "X_At_bats_2_t_1",
                   "X_Bateos_t_1", "X_Bateos_2_t_1",
                   "X_Bateos_promedio_t_1", "X_Bateos_promedio_2_t_1", 
                   "X_Dobles_t_1", "X_Dobles_2_t_1",
                   "X_Home_runs_t_1", "X_Home_runs_2_t_1",
                   "X_Juegos_iniciados_t_1", "X_Juegos_iniciados_2_t_1",
                   "X_Porcentaje_On_base_plus_slugging_t_1", "X_Porcentaje_On_base_plus_slugging_2_t_1",
                   "X_Porcentaje_on_base_t_1", "X_Porcentaje_on_base_2_t_1",
                   "X_Porcentaje_slugging_t_1", "X_Porcentaje_slugging_2_t_1",
                   "X_Runs_batted_in_t_1", "X_Runs_batted_in_2_t_1",
                   "X_Triples_t_1", "X_Triples_2_t_1",
                   "X_WAR_t_1", "X_WAR_2_t_1")
ya_hitter <- list('X_At_bats_t_1', 'X_Bateos_2_t_1',
                  'X_Bateos_promedio_t_1', 'X_Bateos_t_1',
                  'X_Dobles_2_t_1', 'X_Dobles_t_1',
                  'X_Home_runs_2_t_1', 'X_Home_runs_t_1',
                  'X_Juegos_iniciados_2_t_1', 'X_Juegos_iniciados_t_1',
                  'X_Porcentaje_On_base_plus_slugging_2_t_1',
                  'X_Porcentaje_On_base_plus_slugging_t_1',
                  'X_Porcentaje_on_base_2_t_1',
                  'X_Porcentaje_on_base_t_1',
                  'X_Porcentaje_slugging_2_t_1',
                  'X_Runs_batted_in_2_t_1',
                  'X_Triples_2_t_1', 'X_WAR_2_t_1', 'X_WAR_t_1')

# Agreguemos ambos sufijos
X_cum_hitter <- lapply(cum_hitter, function(x) paste(x, "_cum", sep = ""))
X_ya_hitter <- lapply(ya_hitter, function(x) paste(x, "_ya", sep = ""))

# remove the prefix 'X_' from the strings
ya_hitter <- sub("^X_", "", ya_hitter)
cum_hitter <- sub("^X_", "", cum_hitter)

# Lista con todas las variables
X_hitter_var_suf <- c(X_cum_hitter, X_ya_hitter)
hitter_var_suf <- c(ya_hitter, cum_hitter)
```

### Estimación directa

Se obtendrán las estimaciones de las variables referentes a estadísticas deportivas sin controles

```{r}
# Load the dplyr package
library(dplyr)

# Create a sample data frame
df <- data.frame(x = c(10, 20, 30, 40, 50), y = c(100, 200, 300, 400, 500), z = c(1, 2, 3, 4, 5))

# Define the list of column names to normalize
col_list <- c("x", "z")

# Normalize the columns in col_list and add new columns with the suffix "_norm"
df_norm <- df %>% 
  mutate_at(vars(col_list), funs(norm = (.-min(.))/(max(.)-min(.))))

# Print the normalized data frame
print(df_norm)

```


```{r hitter_stimation_simple}
# create a list to store the results
hitter_results_1 <- list()

# loop over the variables in var_hitter_list
for (i in 1:length(X_hitter_var_suf)){
  
  # run linear regression with grouped errors by country and robust errors
  formula <- paste("Y ~ ", X_hitter_var_suf[[i]])
  model <- lm(formula,
              data = hitter_data)
  model_robust <- coeftest(model,
                           vcov = vcovHC(model,
                                         type = "HC1"))
  
  # store the results in the list
  hitter_results_1[[i]] <- list(variable = names(X_hitter_var_suf[i]),
                                model = model_robust)
  
  # show the results
  print(hitter_results_1[[i]])
}
```
```{r}
# create some sample data
x <- c(1, 2, 3, 4, 5)
y <- c(3, 5, 7, 9, 11)

# fit a linear model and store the output
model <- lm(y ~ x)

# extract the p-values and store them in a list
p_values <- summary(model)$coefficients[, 4]

# print the list of p-values to the console
p_values


# extract the coefficient for the 'x' variable
x_coef <- coef(model)["x"]

# extract the p-value for the 'x' variable
x_pvalue <- summary(model)$coefficients["x", "Pr(>|t|)"]

# print the p-value for the 'x' variable to the console
x_pvalue

```
### Designated hitter

```{r d_hitter_stimation}
# create a list to store the results
d_hitter_results <- list()

# loop over the variables in var_hitter_list
for (i in 1:length(hitter_var)){
  
  # run linear regression with grouped errors by country and robust errors
  formula <- paste("Y ~ ", hitter_var[[i]])
  model <- lm(formula, data = d_hitter_data)
  model_robust <- coeftest(model, vcov = vcovHC(model, type = "HC1"))
  
  # store the results in the list
  d_hitter_results[[i]] <- list(variable = names(hitter_var[i]),
                                model = model_robust)
  
  # show the results
  print(d_hitter_results[[i]])
}
```