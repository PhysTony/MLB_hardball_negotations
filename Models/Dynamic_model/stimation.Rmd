---
title: "Dynamic Model"
author: "Antonio Huerta Montellano"
date: "\today"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(comment = NA)
```

```{r libraries, include=FALSE}
library(lmtest) # for robust standard errors
library(dplyr) # for group_by function
library(ggplot2) # for better plots
library(dplyr) # for data managment
library(clubSandwich) # Grouped errors
library(sandwich) # MOre error options
library(tidyr) # Datframes manipulation
library(stargazer) # For output formats
library(lubridate)
library(plm)
```


## Exploración de los paneles

Importemos los paneles donde un pánel corresponde a los bateadores y, el otro, a los fielderos.

```{r import_panel}
setwd("~/Documentos/Github/Proyectos/MLB_HN/")
hitters_panel <- read.csv('ETL_Data/Panel/General/Dynamic_model/dynamic_model_hitter_pca.csv')
fielders_panel <- read.csv('ETL_Data/Panel/General/Dynamic_model/dynamic_model_fielder_pca.csv')
```
Por otro lado, se mostrarán las dimensiones de cada pánel
```{r panel_dimentions}
print("Bateadores: ")
print(dim(hitters_panel))
print("")
print("Fildeadores: ")
print(dim(fielders_panel))
```

Como la posición del jugador es un control, necesitaremos pasar de columna categórica a columna numérica.

```{r position_dummyfication}
# Convert categorical column to numerical
hitters_panel$position_num_t <- as.numeric(factor(hitters_panel$Posicion_t))
fielders_panel$position_num_t <- as.numeric(factor(fielders_panel$Posicion_t))
hitters_panel$team_num_t <- as.numeric(factor(hitters_panel$Acronimo_t))
fielders_panel$team_num_t <- as.numeric(factor(fielders_panel$Acronimo_t))
```

Como adelanto, se descartaron los controles por posición puesto que no son significativos para los modelos y afectan los resultados. Tal vez por el hehco de que los jugadores tienden a rotar de posición en un mismo partido e incluso a lo largo de la temporada. aAgreguemos una columna de 1's que represente la dummy de ser agente libre

```{r fa_dummy}
# add a column of 1s to the panel data
hitters_panel <- cbind(hitters_panel,
                       fa = rep(1, nrow(hitters_panel)))
fielders_panel <- cbind(fielders_panel,
                        fa = rep(1, nrow(fielders_panel)))
```


Debido a que en las estadísticas descriptivas se observó un shock en el año de la pandemia COVID-19, se obtendrán las estimaciones quitando el año 2020.

```{r covid_filter, include=FALSE}
# filter out rows with year 2020
# Bateadores
hitters_panel_covid <- hitters_panel %>% 
                       filter(Anio_t != 2020)
# Fildeadores
fielders_panel_covid <- fielders_panel %>%
                        filter(Anio_t != 2020)
```



## Segmentación por grupo

Lo que haremos es dividir los paneles en ciertas categorías. Primero, veamos todas las posiciones en los páneles
```{r positions}
print("Bateadores:")
print(unique(hitters_panel$Posicion_t))
print("")
print("Fildeadores:")
print(unique(fielders_panel$Posicion_t))
```
Arriba se muestran las posiciones de los jugadores en nuestras bases de datos. A pesar de que en los bateadores aparezcan posiciones defensivas se debe a que estos juegan tanto como ofensivos como defensivos. Estando en la ofensiva se juega en las misma posición que todos por lo que no es necesario especificar que ocupala posición de bateador (**H**). Sin embargo, cuando se dice que es un bateador designado (**DH**) ya que este solo juega en la ofensiva para sustituir a un lanzador/pitcher.

Por otro lado, veamos cuantas observaciones hay por posición.

```{r positions_count_hitter}
hitters_panel %>% count(Posicion_t, sort = TRUE)
```

```{r positions_count_fielder}
fielders_panel %>% count(Posicion_t, sort = TRUE)
```


Continuemos con la segmentación de acuerdo a categorías. Primero, obtendremos el split de todas las posiciones y luego concatenaremos de acuerdo a los grupos de interés:

**Ofensivos:**

- **Bateador designado (DH).**
- **No bateador designado (H).**

Debido a la falta de observaciones para los _outfielders_ es que se omitirá su estimación. Por otro lado, debido a que la mayoría de los datos para los fildeadores son de los lanzadores, podemos agruparlos de la siguiente manera

**Defensivos:**

- **Starting pitcher:** Lanzador inicial (SP).
- **Relief pitcher:** Lanzador de relevo (RP) y lanzador de cierre (RP/CL)
- **Campo corto (SS).**


```{r position_split, include=FALSE}
# split the data frame by category
split_hitter <- split(hitters_panel,
                      f = hitters_panel$Posicion_t)
split_fielder <- split(fielders_panel,
                       f = fielders_panel$Posicion_t)

# COVID panels:
split_hitter_covid <- split(hitters_panel_covid,
                            f = hitters_panel_covid$Posicion_t)
split_fielder_covid <- split(fielders_panel_covid,
                             f = fielders_panel_covid$Posicion_t)
```

Segundo, crearemos las categorías de acuerdo a la especificación mencionada arriba
```{r group_category_split, include=FALSE}
# Whole panel:
# Offensive:
h_category_1 <- split_hitter[["SP"]]
h_category_2 <- split_hitter[["RP"]]
h_category_3 <- split_hitter[["RP/CL"]]
h_category_4 <- split_hitter[["C"]]
h_category_5 <- split_hitter[["1B"]]
h_category_6 <- split_hitter[["2B"]]
h_category_7 <- split_hitter[["3B"]]
h_category_8 <- split_hitter[["SS"]]
h_category_9 <- split_hitter[["RF"]]
h_category_10 <- split_hitter[["CF"]]
h_category_11 <- split_hitter[["LF"]]
d_hitter_data <- split_hitter[["DH"]]

# Defensive:
starting_data <- split_fielder[["SP"]]
b_category_2 <- split_fielder[["RP"]]
b_category_3 <- split_fielder[["RP/CL"]]
shorts_data <- split_fielder[["SS"]]

# COVID panel:
# Offensive:
cov_h_category_1 <- split_hitter_covid[["SP"]]
cov_h_category_2 <- split_hitter_covid[["RP"]]
cov_h_category_3 <- split_hitter_covid[["RP/CL"]]
cov_h_category_4 <- split_hitter_covid[["C"]]
cov_h_category_5 <- split_hitter_covid[["1B"]]
cov_h_category_6 <- split_hitter_covid[["2B"]]
cov_h_category_7 <- split_hitter_covid[["3B"]]
cov_h_category_8 <- split_hitter_covid[["SS"]]
cov_h_category_9 <- split_hitter_covid[["RF"]]
cov_h_category_10 <- split_hitter_covid[["CF"]]
cov_h_category_11 <- split_hitter_covid[["LF"]]
d_hitter_cov_data <- split_hitter_covid[["DH"]]

# Defensive:
starting_cov_data <- split_fielder_covid[["SP"]]
cov_b_category_2 <- split_fielder_covid[["RP"]]
cov_b_category_3 <- split_fielder_covid[["RP/CL"]]
shorts_cov_data <- split_fielder_covid[["SS"]]
```

Tercero, concatenaremos estas bases de datos de acuerdo a los grupos señalados anteriormente

```{r group_concat, include=FALSE}
# All panels:
# Hitters:
# Concatenate the two categories
hitter_data <- rbind(h_category_1, h_category_2, h_category_3, h_category_4,
                     h_category_5, h_category_6, h_category_7, h_category_8,
                     h_category_9, h_category_10, h_category_11)
hitter_data <- unique(hitter_data)

# Fielders:
# Concatenate the two categories
relief_pitcher_data <- rbind(b_category_2, b_category_3)
relief_pitcher_data <- unique(relief_pitcher_data)

# COVID filter:
# Hitters:
# Concatenate the two categories
hitter_cov_data <- rbind(cov_h_category_1, cov_h_category_2, cov_h_category_3, cov_h_category_4,
                         cov_h_category_5, cov_h_category_6, cov_h_category_7, cov_h_category_8,
                         cov_h_category_9, cov_h_category_10, cov_h_category_11)
hitter_cov_data <- unique(hitter_cov_data)

# Fielders:
# Concatenate the two categories
relief_pitcher_cov_data <- rbind(cov_b_category_2, cov_b_category_3)
relief_pitcher_cov_data <- unique(relief_pitcher_cov_data)
```

Veamos las dimensiones de cada una de los paneles sin el shock de la COVID-19:
```{r group_dimentions}
print("Regular hitter: ")
print(dim(hitter_cov_data))
print("")
print("Designated hitter: ")
print(dim(d_hitter_cov_data))
print("")
print("Relief pitchers: ")
print(dim(relief_pitcher_cov_data))
print("")
print("Starting pitchers: ")
print(dim(starting_cov_data))
print("")
print("Short stops: ")
print(dim(shorts_cov_data))
```


## Estimaciones y regresiones

Lo que resta hacer es implementar un algoritmo donde se pueda hacer el siguiente modelo para todas las estadísticas deportiva de acuerdo a si el jugador es defensivo u ofensivo:

$$
Y_{t}(\cdot) = \alpha + \beta_{0}X_{t} + \beta_{1}\text{Controles}_{t} + u_{t}
$$

donde

- $Controles_{t}$:
    - Equipo.
    - Edad.
    - Año.
- $\alpha$: Heterogeneidad del jugador.

Creemos la lista de variables sobre las cuáles se va a iterar el clico
```{r hitter_var_list, include=FALSE}
# LIsta de variables acumuladas y anualmente promediadas_
stat_hitter <- list("X_At_bats", "X_At_bats_2",
                    "X_Bateos", "X_Bateos_2",
                    "X_Bateos_promedio", "X_Bateos_promedio_2", 
                    "X_Dobles", "X_Dobles_2",
                    "X_Home_runs", "X_Home_runs_2",
                    "X_Juegos_iniciados", "X_Juegos_iniciados_2",
                    "X_Porcentaje_On_base_plus_slugging", "X_Porcentaje_On_base_plus_slugging_2",
                    "X_Porcentaje_on_base", "X_Porcentaje_on_base_2",
                    "X_Porcentaje_slugging", "X_Porcentaje_slugging_2",
                    "X_Runs_batted_in", "X_Runs_batted_in_2",
                    "X_Triples", "X_Triples_2",
                    "X_WAR", "X_WAR_2")

# Add suffix "_t" to each name
stat_hitter_t <- paste0(stat_hitter, "_t")
stat_hitter_t_1 <- paste0(stat_hitter, "_t_1")
```

Variables para los fildeadores
```{r fielder_var_list, include = FALSE}
# LIsta de variables acumuladas y anualmente promediadas_
stat_fielder <- list('X_Bateos_2', 'X_Bateos',
                     'X_Carreras_2', 'X_Carreras_ganadas_2',
                     'X_Carreras_ganadas', 'X_Carreras',
                     'X_Comando_2', 'X_Comando',
                     'X_Control_2', 'X_Control',
                     'X_Dominio_2', 'X_Dominio',
                     'X_ERA_2', 'X_ERA',
                     'X_Inning_pitched_2', 'X_Inning_pitched',
                     'X_Losses_2', 'X_Losses',
                     'X_Saves_2', 'X_Saves',
                     'X_Strike_outs_2', 'X_Strike_outs',
                     'X_WAR_2', 'X_WAR',
                     'X_WHIP_2', 'X_WHIP',
                     'X_Walks_2', 'X_Walks',
                     'X_Wins_2', 'X_Wins')

# Add suffix "_t" to each name
stat_fielder_t <- paste0(stat_fielder, "_t")
stat_fielder_t_1 <- paste0(stat_fielder, "_t_1")
```


Las variables base para ambos tipos de jugadores son los controles
```{r controles}
# Constroles:
vars  <- 'Y_Sueldo_regular_norm_t ~ Edad_t + Anios_de_contrato_t + team_num_t'
```

```{r hitter_stats_labels}
hitter_stats_1 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$", 
                   "$X_{AB_{t}}$","$X_{AB_{t-1}}$","$X_{AB^{2}_{t}}$","$X_{AB^{2}_{t-1}}$",
                   "$X_{H_{t}}$","$X_{H_{t-1}}$","$X_{H^{2}_{t}}$","$X_{H^{2}_{t-1}}$",
                   "$X_{BA_{t}}$","$X_{BA_{t-1}}$", "$X_{BA^{2}_{t}}$","$X_{BA^{2}_{t-1}}$",
                   "Intercepto")
hitter_stats_2 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$", 
                   "$X_{D_{t}}$","$X_{D_{t-1}}$","$X_{D^{2}_{t}}$","$X_{D^{2}_{t-1}}$",
                   "$X_{HR_{t}}$","$X_{HR_{t-1}}$","$X_{HR^{2}_{t}}$","$X_{HR^{2}_{t-1}}$",
                   "$X_{GS_{t}}$","$X_{GS_{t-1}}$", "$X_{GS^{2}_{t}}$","$X_{GS^{2}_{t-1}}$",
                   "Intercepto")
hitter_stats_3 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$", 
                   "$X_{OPS_{t}}$","$X_{OPS_{t-1}}$","$X_{OPS^{2}_{t}}$","$X_{OPS^{2}_{t-1}}$",
                   "$X_{OBP_{t}}$","$X_{OBP_{t-1}}$","$X_{OBP^{2}_{t}}$","$X_{OBP^{2}_{t-1}}$",
                   "$X_{SLG_{t}}$","$X_{SLG_{t-1}}$", "$X_{SLG^{2}_{t}}$","$X_{SLG^{2}_{t-1}}$",
                   "Intercepto")
hitter_stats_4 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$", 
                   "$X_{RBI_{t}}$","$X_{RBI_{t-1}}$","$X_{RBI^{2}_{t}}$","$X_{RBI^{2}_{t-1}}$",
                   "$X_{T_{t}}$","$X_{T_{t-1}}$","$X_{T^{2}_{t}}$","$X_{T^{2}_{t-1}}$",
                   "$X_{WAR_{t}}$","$X_{WAR_{t-1}}$", "$X_{WAR^{2}_{t}}$","$X_{WAR^{2}_{t-1}}$",
                   "Intercepto")
hitter_stats <- list(hitter_stats_1,
                     hitter_stats_2,
                     hitter_stats_3,
                     hitter_stats_4)
# Cycles for loop
hitter_rep <- 4
# Stats to show
hitter_stat_num <- 6
```

```{r fielder_stats_labels}
fielder_stats_1 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$", 
                    "$X_{H^{2}_{t}}$","$X_{H^{2}_{t-1}}$","$X_{H_{t}}$","$X_{H_{t-1}}$",
                    "$X_{R^{2}_{t}}$","$X_{R^{2}_{t-1}}$","$X_{ER^{2}_{t}}$","$X_{ER^{2}_{t-1}}$",
                    "$X_{ER_{t}}$","$X_{ER_{t-1}}$", "$X_{R_{t}}$","$X_{R_{t-1}}$",
                    "Intercepto")
fielder_stats_2 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$", 
                    "$X_{Comando^{2}_{t}}$","$X_{Comando^{2}_{t-1}}$","$X_{Comando_{t}}$","$X_{Comando_{t-1}}$",
                    "$X_{Control^{2}_{t}}$","$X_{Control^{2}_{t-1}}$","$Control_{H_{t}}$","$X_{Control_{t-1}}$",
                    "$X_{Dominio^{2}_{t}}$","$X_{Dominio^{2}_{t-1}}$","$X_{Dominio_{t}}$","$X_{Dominio_{t-1}}$",
                    "Intercepto")
fielder_stats_3 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                    "$X_{ERA^{2}_{t}}$","$X_{ERA^{2}_{t-1}}$","$X_{ERA_{t}}$","$X_{ERA_{t-1}}$",
                    "$X_{IP^{2}_{t}}$","$X_{IP^{2}_{t-1}}$","$X_{IP_{t}}$","$X_{IP_{t-1}}$",
                    "$X_{L^{2}_{t}}$","$X_{L^{2}_{t-1}}$", "$X_{L_{t}}$","$X_{L_{t-1}}$",
                    "Intercepto")
fielder_stats_4 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                    "$X_{S^{2}_{t}}$","$X_{S^{2}_{t-1}}$","$X_{S_{t}}$","$X_{S_{t-1}}$",
                    "$X_{SO^{2}_{t}}$","$X_{SO^{2}_{t-1}}$","$X_{SO_{t}}$","$X_{SO_{t-1}}$",
                    "$X_{WAR^{2}_{t}}$","$X_{WAR^{2}_{t-1}}$","$X_{WAR_{t}}$","$X_{WAR_{t-1}}$",
                    "Intercepto")
fielder_stats_5 = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                    "$X_{WHIP^{2}_{t}}$","$X_{WHIP^{2}_{t-1}}$","$X_{WHIP_{t}}$","$X_{WHIP_{t-1}}$",
                    "$X_{BB^{2}_{t}}$","$X_{BB^{2}_{t-1}}$","$X_{BB_{t}}$","$X_{BB_{t-1}}$",
                    "$X_{W^{2}_{t}}$","$X_{W^{2}_{t-1}}$","$X_{W_{t}}$","$X_{W_{t-1}}$",
                    "Intercepto")
fielder_stats <- list(fielder_stats_1,
                      fielder_stats_2,
                      fielder_stats_3,
                      fielder_stats_4,
                      fielder_stats_5)
# Cycles for loop
fielder_rep <- 5
# Stats to show
fielder_stat_num <- 6
```


# Estimaciones directas

## Pooling 

### Bateadores

Se obtendrán las estimaciones de las variables referentes a estadísticas deportivas sin controles

```{r hitter_stimation_simple_pooling}
# Create a model to store the results
hitter_simple_pooling <- list()

# To store the results
hitter_results_simple_pooling_1 <- list()
hitter_results_simple_pooling_2 <- list()
hitter_results_simple_pooling_3 <- list()
hitter_results_simple_pooling_4 <- list()
hitter_results_simple_pooling <- list(result_1 = hitter_results_simple_pooling_1,
                                      result_2 = hitter_results_simple_pooling_2,
                                      result_3 = hitter_results_simple_pooling_3,
                                      result_4 = hitter_results_simple_pooling_4)

# Loop over the variables in var_hitter_list
for (j in 1:hitter_rep){
  
  for (i in 1:hitter_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_hitter_t[[i + hitter_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_hitter_t_1[[i + hitter_stat_num*(j - 1)]],
                     sep = " + ")
    
    hitter_simple_pooling[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = hitter_data,
                                                  model = "pooling",
                                                  index = c("id", "Anio_ref"))
        
    hitter_results_simple_pooling[[j]][[i]] <- coeftest(hitter_simple_pooling[[i + hitter_stat_num*(j - 1)]],
                                                        vcov = vcovHC(hitter_simple_pooling[[i + hitter_stat_num*(j - 1)]],
                                                                      type = "HC1",
                                                                      cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(hitter_results_simple_pooling[[j]],
          no.space = TRUE,
          type = "text",
          title = "Bateadores: Modelo Pooling",
          covariate.labels = hitter_stats[[j]])
}
```



### Starting pitcher

```{r starting_stimation_pooling}
# Create a model to store the results
fielder_simple_pooling <- list()

# To store the results
fielder_results_simple_pooling_1 <- list()
fielder_results_simple_pooling_2 <- list()
fielder_results_simple_pooling_3 <- list()
fielder_results_simple_pooling_4 <- list()
fielder_results_simple_pooling_5 <- list()
fielder_results_simple_pooling <- list(result_1 = fielder_results_simple_pooling_1,
                                       result_2 = fielder_results_simple_pooling_2,
                                       result_3 = fielder_results_simple_pooling_3,
                                       result_4 = fielder_results_simple_pooling_4,
                                       result_5 = fielder_results_simple_pooling_5)

# Loop over the variables in var_hitter_list
for (j in 1:fielder_rep){
  
  for (i in 1:fielder_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_fielder_t[[i + fielder_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_fielder_t_1[[i + fielder_stat_num*(j - 1)]],
                     sep = " + ")
    
    fielder_simple_pooling[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = starting_data,
                                                  model = "pooling",
                                                  index = c("id", "Anio_ref"))
        
    fielder_results_simple_pooling[[j]][[i]] <- coeftest(fielder_simple_pooling[[i + fielder_stat_num*(j - 1)]],
                                                         vcov = vcovHC(fielder_simple_pooling[[i + fielder_stat_num*(j - 1)]],
                                                                       type = "HC1",
                                                                       cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(fielder_results_simple_pooling[[j]],
          no.space = TRUE,
          type = "text",
          title = "Lanzadores Iniciales: Modelo Pooling",
          covariate.labels = fielder_stats[[j]])
}
```

## Efectos fijos

### Bateadores

Se obtendrán las estimaciones de las variables referentes a estadísticas deportivas sin controles

```{r hitter_stimation_simple_within}
# Create a model to store the results
hitter_simple_within <- list()

# To store the results
hitter_results_simple_within_1 <- list()
hitter_results_simple_within_2 <- list()
hitter_results_simple_within_3 <- list()
hitter_results_simple_within_4 <- list()
hitter_results_simple_within <- list(result_1 = hitter_results_simple_within_1,
                                      result_2 = hitter_results_simple_within_2,
                                      result_3 = hitter_results_simple_within_3,
                                      result_4 = hitter_results_simple_within_4)

# Loop over the variables in var_hitter_list
for (j in 1:hitter_rep){
  
  for (i in 1:hitter_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_hitter_t[[i + hitter_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_hitter_t_1[[i + hitter_stat_num*(j - 1)]],
                     sep = " + ")
    
    hitter_simple_within[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = hitter_data,
                                                  model = "within",
                                                  index = c("id", "Anio_ref"))
        
    hitter_results_simple_within[[j]][[i]] <- coeftest(hitter_simple_within[[i + hitter_stat_num*(j - 1)]],
                                                        vcov = vcovHC(hitter_simple_within[[i + hitter_stat_num*(j - 1)]],
                                                                      type = "HC1",
                                                                      cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(hitter_results_simple_pooling[[j]],
          no.space = TRUE,
          type = "text",
          title = "Bateadores: Estimador Within",
          covariate.labels = hitter_stats[[j]])
}
```

### Starting pitcher

```{r starting_stimation_within}
# Create a model to store the results
fielder_simple_within <- list()

# To store the results
fielder_results_simple_within_1 <- list()
fielder_results_simple_within_2 <- list()
fielder_results_simple_within_3 <- list()
fielder_results_simple_within_4 <- list()
fielder_results_simple_within_5 <- list()
fielder_results_simple_within <- list(result_1 = fielder_results_simple_within_1,
                                       result_2 = fielder_results_simple_within_2,
                                       result_3 = fielder_results_simple_within_3,
                                       result_4 = fielder_results_simple_within_4,
                                       result_5 = fielder_results_simple_within_5)

# Loop over the variables in var_hitter_list
for (j in 1:fielder_rep){
  
  for (i in 1:fielder_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_fielder_t[[i + fielder_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_fielder_t_1[[i + fielder_stat_num*(j - 1)]],
                     sep = " + ")
    
    fielder_simple_within[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = starting_data,
                                                  model = "within",
                                                  index = c("id", "Anio_ref"))
        
    fielder_results_simple_within[[j]][[i]] <- coeftest(fielder_simple_within[[i + fielder_stat_num*(j - 1)]],
                                                         vcov = vcovHC(fielder_simple_within[[i + fielder_stat_num*(j - 1)]],
                                                                       type = "HC1",
                                                                       cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(fielder_results_simple_within[[j]],
          no.space = TRUE,
          type = "text",
          title = "Lanzadores Iniciales: Estimador Within",
          covariate.labels = fielder_stats[[j]])
}
```

## Efectos aleatorios

### Bateadores

Se obtendrán las estimaciones de las variables referentes a estadísticas deportivas sin controles

```{r hitter_stimation_simple_random}
# Create a model to store the results
hitter_simple_random <- list()

# To store the results
hitter_results_simple_random_1 <- list()
hitter_results_simple_random_2 <- list()
hitter_results_simple_random_3 <- list()
hitter_results_simple_random_4 <- list()
hitter_results_simple_random <- list(result_1 = hitter_results_simple_random_1,
                                      result_2 = hitter_results_simple_random_2,
                                      result_3 = hitter_results_simple_random_3,
                                      result_4 = hitter_results_simple_random_4)

# Loop over the variables in var_hitter_list
for (j in 1:hitter_rep){
  
  for (i in 1:hitter_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_hitter_t[[i + hitter_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_hitter_t_1[[i + hitter_stat_num*(j - 1)]],
                     sep = " + ")
    
    hitter_simple_random[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = hitter_data,
                                                  model = "random",
                                                  index = c("id", "Anio_ref"))
        
    hitter_results_simple_random[[j]][[i]] <- coeftest(hitter_simple_random[[i + hitter_stat_num*(j - 1)]],
                                                        vcov = vcovHC(hitter_simple_random[[i + hitter_stat_num*(j - 1)]],
                                                                      type = "HC1",
                                                                      cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(hitter_results_simple_random[[j]],
          no.space = TRUE,
          type = "text",
          title = "Bateadores: Efectos Aleatorios",
          covariate.labels = hitter_stats[[j]])
}
```

### Starting pitcher

```{r starting_stimation_random}
# Create a model to store the results
fielder_simple_random <- list()

# To store the results
fielder_results_simple_random_1 <- list()
fielder_results_simple_random_2 <- list()
fielder_results_simple_random_3 <- list()
fielder_results_simple_random_4 <- list()
fielder_results_simple_random_5 <- list()
fielder_results_simple_random <- list(result_1 = fielder_results_simple_random_1,
                                       result_2 = fielder_results_simple_random_2,
                                       result_3 = fielder_results_simple_random_3,
                                       result_4 = fielder_results_simple_random_4,
                                       result_5 = fielder_results_simple_random_5)

# Loop over the variables in var_hitter_list
for (j in 1:fielder_rep){
  
  for (i in 1:fielder_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_fielder_t[[i + fielder_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_fielder_t_1[[i + fielder_stat_num*(j - 1)]],
                     sep = " + ")
    
    fielder_simple_random[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = starting_data,
                                                  model = "random",
                                                  index = c("id", "Anio_ref"))
        
    fielder_results_simple_random[[j]][[i]] <- coeftest(fielder_simple_random[[i + fielder_stat_num*(j - 1)]],
                                                         vcov = vcovHC(fielder_simple_random[[i + fielder_stat_num*(j - 1)]],
                                                                       type = "HC1",
                                                                       cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(fielder_results_simple_random[[j]],
          no.space = TRUE,
          type = "text",
          title = "Lanzadores Iniciales: Efectos Aleatorios",
          covariate.labels = fielder_stats[[j]])
}
```

## First Differences

### Bateadores

Se obtendrán las estimaciones de las variables referentes a estadísticas deportivas sin controles

```{r hitter_stimation_simple_fd}
# Create a model to store the results
hitter_simple_fd <- list()

# To store the results
hitter_results_simple_fd_1 <- list()
hitter_results_simple_fd_2 <- list()
hitter_results_simple_fd_3 <- list()
hitter_results_simple_fd_4 <- list()
hitter_results_simple_fd <- list(result_1 = hitter_results_simple_fd_1,
                                 result_2 = hitter_results_simple_fd_2,
                                 result_3 = hitter_results_simple_fd_3,
                                 result_4 = hitter_results_simple_fd_4)

# Loop over the variables in var_hitter_list
for (j in 1:hitter_rep){
  
  for (i in 1:hitter_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_hitter_t[[i + hitter_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_hitter_t_1[[i + hitter_stat_num*(j - 1)]],
                     sep = " + ")
    
    hitter_simple_fd[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = hitter_data,
                                                  model = "fd",
                                                  index = c("id", "Anio_ref"))
        
    hitter_results_simple_fd[[j]][[i]] <- coeftest(hitter_simple_fd[[i + hitter_stat_num*(j - 1)]],
                                                       vcov = vcovHC(hitter_simple_fd[[i + hitter_stat_num*(j - 1)]],
                                                                     type = "HC1",
                                                                     cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(hitter_results_simple_fd[[j]],
          no.space = TRUE,
          type = "text",
          title = "Bateadores: Primeras Diferencias",
          covariate.labels = hitter_stats[[j]])
}
```

### Starting pitcher

```{r starting_stimation_fd}
# Create a model to store the results
fielder_simple_fd <- list()

# To store the results
fielder_results_simple_fd_1 <- list()
fielder_results_simple_fd_2 <- list()
fielder_results_simple_fd_3 <- list()
fielder_results_simple_fd_4 <- list()
fielder_results_simple_fd_5 <- list()
fielder_results_simple_fd <- list(result_1 = fielder_results_simple_fd_1,
                                       result_2 = fielder_results_simple_fd_2,
                                       result_3 = fielder_results_simple_fd_3,
                                       result_4 = fielder_results_simple_fd_4,
                                       result_5 = fielder_results_simple_fd_5)

# Loop over the variables in var_hitter_list
for (j in 1:fielder_rep){
  
  for (i in 1:fielder_stat_num){
    # Run linear regression with grouped errors by country and robust errors
    base_vars_h  <- paste(vars, stat_fielder_t[[i + fielder_stat_num*(j - 1)]],
                        sep = '+')
    formula <- paste(base_vars_h,
                     stat_fielder_t_1[[i + fielder_stat_num*(j - 1)]],
                     sep = " + ")
    
    fielder_simple_fd[[i + hitter_stat_num*(j - 1)]] <- plm(formula, data = starting_data,
                                                  model = "fd",
                                                  index = c("id", "Anio_ref"))
        
    fielder_results_simple_fd[[j]][[i]] <- coeftest(fielder_simple_fd[[i + fielder_stat_num*(j - 1)]],
                                                         vcov = vcovHC(fielder_simple_fd[[i + fielder_stat_num*(j - 1)]],
                                                                       type = "HC1",
                                                                       cluster = "group"))
  }
  
  # Print the third block of results
  stargazer(fielder_results_simple_fd[[j]],
          no.space = TRUE,
          type = "text",
          title = "Lanzadores Iniciales: Efectos Aleatorios",
          covariate.labels = fielder_stats[[j]])
}
```

```{r}
hitter_vars_1 <- c("X_Bateos",
                   "X_Porcentaje_On_base_plus_slugging_2",
                    "X_Porcentaje_on_base",
                    "X_Porcentaje_on_base_2",
                    "X_Porcentaje_slugging_2",
                    "X_Runs_batted_in",
                    "X_Triples",
                    "X_WAR",
                    "X_WAR_2")
hitter_vars_1 <- paste(hitter_vars_1,
                      collapse = " + ")
```


# Estimaciones conjuntas
Lo que se hará ahora es volver a estimar los modelos anteriores, pero con todas las variables que fueron significativas para un nivel del $\%5$. 

## Bateadores

Para los bateadores las variables significativas son:

```{r hitter_stimation}
# Significant variables:
# Pooling:
hitter_vars_1 <- c("X_Bateos",
                   "X_Porcentaje_On_base_plus_slugging_2",
                    "X_Porcentaje_on_base",
                    "X_Porcentaje_on_base_2",
                    "X_Porcentaje_slugging_2",
                    "X_Runs_batted_in",
                    "X_Triples",
                    "X_WAR",
                    "X_WAR_2")
# Add suffix "_t" to each name
stat_hitter_t <- paste0(hitter_vars_1, "_t")
stat_hitter_t_1 <- paste0(hitter_vars_1, "_t_1")
# Lista 
hitter_vars_1 <- c(paste(stat_hitter_t, collapse = " + "),
                   paste(stat_hitter_t_1, collapse = " + "))
# Within
hitter_vars_2 <- c("X_Bateos",
                   "X_Porcentaje_On_base_plus_slugging_2",
                   "X_Porcentaje_on_base",
                   "X_Porcentaje_on_base_2",
                    "X_Porcentaje_slugging_2",
                    "X_Runs_batted_in",
                    "X_Triples",
                    "X_WAR",
                    "X_WAR_2")
# Add suffix "_t" to each name
stat_hitter_t <- paste0(hitter_vars_2, "_t")
stat_hitter_t_1 <- paste0(hitter_vars_2, "_t_1")
# Lista 
hitter_vars_2 <- c(paste(stat_hitter_t, collapse = " + "),
                   paste(stat_hitter_t_1, collapse = " + "))
# Random effects
hitter_vars_3 <- c("X_Porcentaje_On_base_plus_slugging_2",
                   "X_Triples",
                   "X_WAR",
                   "X_WAR_2")
# Add suffix "_t" to each name
stat_hitter_t <- paste0(hitter_vars_3, "_t")
stat_hitter_t_1 <- paste0(hitter_vars_3, "_t_1")
# Lista 
hitter_vars_3 <- c(paste(stat_hitter_t, collapse = " + "),
                   paste(stat_hitter_t_1, collapse = " + "))
# First Differences
hitter_vars_4 <- c("X_At_bats",
                   "X_Bateos_2",
                   "X_Bateos",
                   "X_Bateos_promedio",
                   "X_Bateos_promedio_2",
                   "X_Home_runs",
                   "X_Home_runs_2",
                   "X_Juegos_iniciados",
                   "X_Porcentaje_On_base_plus_slugging",
                   "X_Porcentaje_On_base_plus_slugging_2",
                   "X_Porcentaje_on_base",
                   "X_Porcentaje_on_base_2",
                   "X_Runs_batted_in",
                   "X_Triples",
                   "X_Triples_2",
                   "X_WAR",
                   "X_WAR_2")
# Add suffix "_t" to each name
stat_hitter_t <- paste0(hitter_vars_4, "_t")
stat_hitter_t_1 <- paste0(hitter_vars_4, "_t_1")
# Lista 
hitter_vars_4 <- c(paste(stat_hitter_t, collapse = " + "),
                   paste(stat_hitter_t_1, collapse = " + "))


# Pooling:
formula <- paste(vars,
                 hitter_vars_1[[1]],
                 sep = " + ")
formula <- paste(formula,
                 hitter_vars_1[[2]],
                 sep = " + ")
# Create a model to store the results
hitter_stimation_1 <- plm(formula, data = hitter_data,
                          model = "pooling",
                          index = c("id", "Anio_ref"))
# To store the results
hitter_results_stimation_1 <- coeftest(hitter_stimation_1,
                                       vcov = vcovHC(hitter_stimation_1,
                                                     type = "HC1",
                                                     cluster = "group"))
# Within:
formula <- paste(vars,
                 hitter_vars_2[[1]],
                 sep = " + ")
formula <- paste(formula,
                 hitter_vars_2[[2]],
                 sep = " + ")
# Create a model to store the results
hitter_stimation_2 <- plm(formula, data = hitter_data,
                          model = "within",
                          index = c("id", "Anio_ref"))
# To store the results
hitter_results_stimation_2 <- coeftest(hitter_stimation_2,
                                       vcov = vcovHC(hitter_stimation_2,
                                                     type = "HC1",
                                                     cluster = "group"))
# Random:
formula <- paste(vars,
                 hitter_vars_3[[1]],
                 sep = " + ")
formula <- paste(formula,
                 hitter_vars_3[[2]],
                 sep = " + ")
# Create a model to store the results
hitter_stimation_3 <- plm(formula, data = hitter_data,
                          model = "random",
                          index = c("id", "Anio_ref"))
# To store the results
hitter_results_stimation_3 <- coeftest(hitter_stimation_3,
                                       vcov = vcovHC(hitter_stimation_3,
                                                     type = "HC1",
                                                     cluster = "group"))
# First Differences:
formula <- paste(vars,
                 hitter_vars_4[[1]],
                 sep = " + ")
formula <- paste(formula,
                 hitter_vars_4[[2]],
                 sep = " + ")
# Create a model to store the results
hitter_stimation_4 <- plm(formula, data = hitter_data,
                          model = "fd",
                          index = c("id", "Anio_ref"))
# To store the results
hitter_results_stimation_4 <- coeftest(hitter_stimation_4,
                                       vcov = vcovHC(hitter_stimation_4,
                                                     type = "HC1",
                                                     cluster = "group"))

# Modelos
hitter_models <- list(pooling = hitter_results_stimation_1,
                      within = hitter_results_stimation_2,
                      random = hitter_results_stimation_3,
                      fd = hitter_results_stimation_4)


# Print the third block of results
stargazer(hitter_models,
         no.space = TRUE,
         align = TRUE,
         type = "text",
         title = "Bateadores: Comparación de los modelos",
         covariate.labels = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$", 
                              "$X_{AB_{t}}$","$X_{AB_{t-1}}$",
                              "$X_{H_{t}}$","$X_{H_{t-1}}$","$X_{H^{2}_{t}}$","$X_{H^{2}_{t-1}}$",
                              "$X_{BA_{t}}$","$X_{BA_{t-1}}$", "$X_{BA^{2}_{t}}$","$X_{BA^{2}_{t-1}}$",
                              "$X_{HR_{t}}$","$X_{HR_{t-1}}$","$X_{HR^{2}_{t}}$","$X_{HR^{2}_{t-1}}$",
                              "$X_{GS_{t}}$","$X_{GS_{t-1}}$",
                              "$X_{OPS_{t}}$","$X_{OPS_{t-1}}$","$X_{OPS^{2}_{t}}$","$X_{OPS^{2}_{t-1}}$",
                              "$X_{OBP_{t}}$","$X_{OBP_{t-1}}$","$X_{OBP^{2}_{t}}$","$X_{OBP^{2}_{t-1}}$",
                              "$X_{SLG^{2}_{t}}$","$X_{SLG^{2}_{t-1}}$",
                              "$X_{RBI_{t}}$","$X_{RBI_{t-1}}$",
                              "$X_{T_{t}}$","$X_{T_{t-1}}$","$X_{T^{2}_{t}}$","$X_{T^{2}_{t-1}}$",
                              "$X_{WAR_{t}}$","$X_{WAR_{t-1}}$", "$X_{WAR^{2}_{t}}$","$X_{WAR^{2}_{t-1}}$",
                              "Intercepto"))
```

## Lanzadores

```{r fielder_stimation_pooling}
# Significant variables:
fielder_vars_1 <- c('X_Control_2',
                    'X_Control',
                    'X_Dominio_2',
                    'X_Dominio',
                    'X_ERA_2',
                    'X_ERA',
                    'X_Saves_2',
                    'X_Saves',
                    'X_WHIP_2',
                    'X_WHIP')
# Add suffix "_t" to each name
stat_fielder_t <- paste0(fielder_vars_1, "_t")
stat_fielder_t_1 <- paste0(fielder_vars_1, "_t_1")
# Lista 
fielder_vars_1 <- c(paste(stat_fielder_t, collapse = " + "),
                   paste(stat_fielder_t_1, collapse = " + "))
# Within
fielder_vars_2 <- c('X_Carreras',
                    'X_Comando_2',
                    'X_ERA',
                    'X_Saves_2',
                    'X_Saves',
                    'X_Strike_outs_2',
                    'X_WAR_2')
# Add suffix "_t" to each name
stat_fielder_t <- paste0(fielder_vars_2, "_t")
stat_fielder_t_1 <- paste0(fielder_vars_2, "_t_1")
# Lista 
fielder_vars_2 <- c(paste(stat_fielder_t, collapse = " + "),
                   paste(stat_fielder_t_1, collapse = " + "))
# Random effects
fielder_vars_3 <- c('X_Control_2',
                    'X_Control',
                    'X_Dominio_2',
                    'X_Dominio',
                    'X_ERA_2',
                    'X_ERA',
                    'X_Saves_2',
                    'X_Saves',
                    'X_WHIP_2',
                    'X_WHIP')
# Add suffix "_t" to each name
stat_fielder_t <- paste0(fielder_vars_3, "_t")
stat_fielder_t_1 <- paste0(fielder_vars_3, "_t_1")
# Lista 
fielder_vars_3 <- c(paste(stat_fielder_t, collapse = " + "),
                   paste(stat_fielder_t_1, collapse = " + "))
# First Differences
fielder_vars_4 <- c('X_Bateos_2',
                    'X_Bateos',
                    'X_Carreras_ganadas_2',
                    'X_Carreras_ganadas',
                    'X_ERA',
                    'X_Carreras',
                    'X_Comando_2',
                    'X_Comando',
                    'X_Control_2',
                    'X_Control',
                    'X_Dominio_2',
                    'X_Dominio',
                    'X_Inning_pitched_2',
                    'X_Inning_pitched',
                    'X_Losses_2',
                    'X_Saves_2',
                    'X_Saves',
                    'X_Strike_outs_2',
                    'X_Strike_outs',
                    'X_WAR_2', 
                    'X_WHIP_2',
                    'X_WHIP',
                    'X_Walks_2',
                    'X_Walks',
                    'X_Wins')
# Add suffix "_t" to each name
stat_fielder_t <- paste0(fielder_vars_4, "_t")
stat_fielder_t_1 <- paste0(fielder_vars_4, "_t_1")
# Lista 
fielder_vars_4 <- c(paste(stat_fielder_t, collapse = " + "),
                   paste(stat_fielder_t_1, collapse = " + "))


# Pooling:
formula <- paste(vars,
                 fielder_vars_1[[1]],
                 sep = " + ")
formula <- paste(formula,
                 fielder_vars_1[[2]],
                 sep = " + ")
# Create a model to store the results
fielder_stimation_1 <- plm(formula, data = starting_data,
                          model = "pooling",
                          index = c("id", "Anio_ref"))
# To store the results
fielder_results_stimation_1 <- coeftest(fielder_stimation_1,
                                       vcov = vcovHC(fielder_stimation_1,
                                                     type = "HC1",
                                                     cluster = "group"))
# Within:
formula <- paste(vars,
                 fielder_vars_2[[1]],
                 sep = " + ")
formula <- paste(formula,
                 fielder_vars_2[[2]],
                 sep = " + ")
# Create a model to store the results
fielder_stimation_2 <- plm(formula, data = starting_data,
                          model = "within",
                          index = c("id", "Anio_ref"))
# To store the results
fielder_results_stimation_2 <- coeftest(fielder_stimation_2,
                                       vcov = vcovHC(fielder_stimation_2,
                                                     type = "HC1",
                                                     cluster = "group"))
# Random:
formula <- paste(vars,
                 fielder_vars_3[[1]],
                 sep = " + ")
formula <- paste(formula,
                 fielder_vars_3[[2]],
                 sep = " + ")
# Create a model to store the results
fielder_stimation_3 <- plm(formula, data = starting_data,
                          model = "random",
                          index = c("id", "Anio_ref"))
# To store the results
fielder_results_stimation_3 <- coeftest(fielder_stimation_3,
                                       vcov = vcovHC(fielder_stimation_3,
                                                     type = "HC1",
                                                     cluster = "group"))
# First Differences:
formula <- paste(vars,
                 fielder_vars_4[[1]],
                 sep = " + ")
formula <- paste(formula,
                 fielder_vars_4[[2]],
                 sep = " + ")
# Create a model to store the results
fielder_stimation_4 <- plm(formula, data = starting_data ,
                          model = "fd",
                          index = c("id", "Anio_ref"))
# To store the results
fielder_results_stimation_4 <- coeftest(fielder_stimation_4,
                                       vcov = vcovHC(fielder_stimation_4,
                                                     type = "HC1",
                                                     cluster = "group"))

# Modelos
fielder_models <- list(pooling = fielder_results_stimation_1,
                      within = fielder_results_stimation_2,
                      random = fielder_results_stimation_3,
                      fd = fielder_results_stimation_4)


# Print the third block of results
stargazer(fielder_models,
         no.space = TRUE,
         align = TRUE,
         type = "text",
         title = "Lanzadores Iniciales: Comparación de los modelos")
```


# PCA - Estimación directa

Lo que haremos ahore es obtener los estimadores con los componentes principales obtenidos en el tratamiento de los páneles, lo cuales ya son el número óptimo de componentes.

## Pooling

### Bateadores

```{r hitter_stimation_simple_pooling_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t + pca1_t_1'

formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

# Create a model to store the results
hitter_simple_pooling_pca <- plm(formula, data = hitter_data,
                         model = "pooling",
                         index = c("id", "Anio_ref"))

# To store the results
hitter_results_simple_pooling_pca <- coeftest(hitter_simple_pooling_pca,
                                      vcov = vcovHC(hitter_simple_pooling_pca,
                                                    type = "HC1",
                                                    cluster = "group"))

# Print the third block of results
stargazer(hitter_results_simple_pooling_pca,
        no.space = TRUE,
        type = "text",
        title = "Bateadores: Modelo Pooling con PCA",
        covariate.labels = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{1_{t-1}}$",
                             "Intercepto"))
```

### Starting pitcher

```{r starting_stimation_pooling_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t + pca2_t + pca1_t_1 + pca2_t_1'
formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

# Create a model to store the results
fielder_simple_poooling_pca <- plm(formula, data = starting_data,
                          model = "pooling",
                          index = c("id", "Anio_ref"))

# To store the results
fielder_results_simple_pooling_pca <- coeftest(fielder_simple_poooling_pca,
                                       vcov = vcovHC(fielder_simple_poooling_pca,
                                                     type = "HC1",
                                                     cluster = "group"))

# Print the third block of results
stargazer(fielder_results_simple_pooling_pca,
        no.space = TRUE,
        type = "text",
        title = "Lanzadores Iniciales: Modelo Pooling con PCA",
        covariate.labels = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{2_{t}}$", "PCA$_{1_{t-1}}$", "PCA$_{2_{t-1}}$",
                             "Intercepto"))
```

## Efectos fijos

### Bateadores

```{r hitter_stimation_simple_fe_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t + pca1_t_1'
formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

# Create a model to store the results
hitter_simple_within_pca <- plm(formula, data = hitter_data,
                       model = "within",
                       index = c("id", "Anio_ref"))

# To store the results
hitter_results_simple_within_pca <- coeftest(hitter_simple_within_pca,
                                      vcov = vcovHC(hitter_simple_within_pca,
                                        type = "HC1",
                                        cluster = "group"))

# Print the third block of results
stargazer(hitter_results_simple_within_pca,
        no.space = TRUE,
        type = "text",
        title = "Bateadores: Estimador Within con PCA",
        covariate.labels = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{1_{t-1}}$",
                             "Intercepto"))
```

### Starting pitcher

```{r starting_stimation_fe_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t + pca2_t + pca1_t_1 + pca2_t_1'
formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

# Create a model to store the results
fielder_simple_within_pca <- plm(formula, data = starting_data,
                               model = "within",
                               index = c("id", "Anio_ref"))

# To store the results
fielder_results_simple_within_pca <- coeftest(fielder_simple_within_pca,
                                              vcov = vcovHC(fielder_simple_within_pca,
                                                            type = "HC1",
                                                            cluster = "group"))


# Print the third block of results
stargazer(fielder_results_simple_within_pca,
        no.space = TRUE,
        type = "text",
        title = "Lanzadores Iniciales: Estimador Within con PCA",
        covariate.labels = c("$Edad_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{2_{t}}$", "PCA$_{1_{t-1}}$", "PCA$_{2_{t-1}}$",
                             "Intercepto"))
```

## Efectos aleatorios

### Bateadores

```{r hitter_stimation_simple_random_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t + pca1_t_1'
formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

# Create a model to store the results
hitter_simple_random_pca <- plm(formula, data = hitter_data,
                               model = "random",
                               index = c("id", "Anio_ref"))

# To store the results
hitter_results_simple_random_pca <- coeftest(hitter_simple_random_pca,
                                        vcov = vcovHC(hitter_simple_random_pca,
                                                      type = "HC1",
                                                      cluster = "group"))

# Print the third block of results
stargazer(hitter_results_simple_random_pca,
        no.space = TRUE,
        type = "text",
        title = "Bateadores: Efectos Aleatorios con PCA",
        covariate.labels = c("Edad$_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{1_{t-1}}$",
                             "Intercepto"))
```

### Starting pitcher

```{r starting_stimation_random_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t + pca2_t + pca1_t_1 + pca2_t_1'
formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

# Create a model to store the results
fielder_simple_random_pca <- plm(formula, data = starting_data,
                               model = "random",
                               index = c("id", "Anio_ref"))

# To store the results
fielder_results_simple_random_pca <- coeftest(fielder_simple_random_pca,
                                              vcov = vcovHC(fielder_simple_random_pca,
                                                            type = "HC1",
                                                            cluster = "group"))

# Print the third block of results
stargazer(fielder_results_simple_random_pca,
        no.space = TRUE,
        type = "text",
        title = "Lanzadores Iniciales: Efectos Aleatorios con PCA",
        covariate.labels = c("Edad$_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{2_{t}}$", "PCA$_{1_{t-1}}$", "PCA$_{2_{t-1}}$",
                             "Intercepto"))
```

## First Differences

### Bateadores

```{r hitter_stimation_simple_fd_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t+ pca1_t_1'
formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

hitter_simple_fd_pca <- plm(formula, data = hitter_data,
                             model = "fd",
                             index = c("id", "Anio_ref"))

# To store the results
hitter_results_simple_fd_pca <- coeftest(hitter_simple_fd_pca,
                                        vcov = vcovHC(hitter_simple_fd_pca,
                                                      type = "HC1",
                                                      cluster = "group"))

# Print the third block of results
stargazer(hitter_results_simple_fd_pca,
        no.space = TRUE,
        type = "text",
        title = "Bateadores: Primeras Diferencias con PCA",
        covariate.labels = c("Edad$_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{1_{t-1}}$",
                             "Intercepto"))
```

### Starting pitcher

```{r starting_stimation_fd_pca}
# run linear regression with grouped errors by country and robust errors
pca_vars <- 'pca1_t + pca2_t + pca1_t_1 + pca2_t_1'
formula <- paste(vars,
                 pca_vars,
                 sep = " + ")

fielder_simple_fd_pca <- plm(formula, data = starting_data,
                               model = "fd",
                               index = c("id", "Anio_ref"))

# To store the results
fielder_results_simple_fd_pca <- coeftest(fielder_simple_fd_pca,
                                              vcov = vcovHC(fielder_simple_fd_pca,
                                                            type = "HC1",
                                                            cluster = "group"))

# Print the third block of results
stargazer(fielder_results_simple_fd_pca,
        no.space = TRUE,
        type = "text",
        title = "Lanzadores Iniciales: Primeras Diferencias con PCA",
        covariate.labels = c("Edad$_{t}$" , "Años contrato$_{t}$", "Eqipo$_{t}$",
                             "PCA$_{1_{t}}$", "PCA$_{2_{t}}$", "PCA$_{1_{t-1}}$", "PCA$_{2_{t-1}}$",
                             "Intercepto"))
```

# Comparación entre periodos

Obtendremos los estimadores para los primeros dos años de observación para luego compararlos con los estimadores para el resto de años. Primero, aseguremos que los páneles estén ordenados por nombre y año de referencia

```{r order_player_anio_ref}
# Sort dataframe by player name and year_ref
hitter_data <- hitter_data %>% arrange(Jugador, Anio_ref)
# Sort dataframe by player name and year_ref
starting_data <- starting_data %>% arrange(Jugador, Anio_ref)
```

```{r split_hitter_data_periods, include=FALSE}
# Split the data into two data frames
hitter_data_split <- hitter_data %>% 
                     group_split(Jugador) 

# Keep only the first two years in the first data frame
hitter_first_two <- hitter_data_split %>% 
                    lapply(function(x) if(nrow(x) >= 2) head(x, 2) else NULL) %>% 
                    bind_rows()

# Keep the remaining years in the second data frame
hitter_remaining <- hitter_data_split %>% 
                    lapply(function(x) if(nrow(x) > 2) tail(x, -2) else NULL) %>% 
                    bind_rows()
```

```{r split_fielder_data_periods, include=FALSE}
# Split the data into two data frames
starting_data_split <- starting_data %>% 
                      group_split(Jugador) 

# Keep only the first two years in the first data frame
starting_first_two <- starting_data_split %>% 
                      lapply(function(x) if(nrow(x) >= 2) head(x, 2) else NULL) %>% 
                      bind_rows()

# Keep the remaining years in the second data frame
starting_remaining <- starting_data_split %>% 
                      lapply(function(x) if(nrow(x) > 2) tail(x, -2) else NULL) %>% 
                      bind_rows()
```

Haremos las estimaciones con todos los modelos para obtener un análisis robusto

## Primeros dos años

## Pooling 

### Bateadores

```{r hitter_stimation_simple_pooling_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_hitter_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_h  <- paste(vars, stat_hitter_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_h,
                   stat_hitter_t_1[[i]],
                   sep = " + ")
  
  print("First two years")
  h_m_pooled_i <- plm(formula, data = hitter_first_two,
                      model = "pooling",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(h_m_pooled_i,
                              vcov = vcovHC(h_m_pooled_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years")
  h_m_pooled_f <- plm(formula, data = hitter_remaining,
                      model = "pooling",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(h_m_pooled_f,
                              vcov = vcovHC(h_m_pooled_f,
                                            type = "HC1",
                                            cluster = "group"))
  
  print(my_lm_cluster_f)
  
  print("Test")
  print(phtest(h_m_pooled_i,h_m_pooled_f))
}
```

### Starting pitcher

```{r starting_stimation_pooling_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_fielder_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_s  <- paste(vars, stat_fielder_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_s,
                   stat_fielder_t_1[[i]],
                   sep = " + ")
  
  print("First two years:")
  s_m_pooled_i <- plm(formula, data = starting_first_two,
                      model = "pooling",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(s_m_pooled_i,
                              vcov = vcovHC(s_m_pooled_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years:")
  s_m_pooled_f <- plm(formula, data = starting_remaining,
                      model = "pooling",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(s_m_pooled_f,
                              vcov = vcovHC(s_m_pooled_f,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_f)
  
  print("Wu-Haussman test:")
  print(phtest(s_m_pooled_i,s_m_pooled_f))
}
```

## Efectos fijos

### Bateadores

```{r hitter_stimation_simple_within_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_hitter_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_h  <- paste(vars, stat_hitter_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_h,
                   stat_hitter_t_1[[i]],
                   sep = " + ")
  
  print("FIrst two years:")
  h_m_fix_ef_i <- plm(formula, data = hitter_first_two,
                      model = "within",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(h_m_fix_ef_i,
                              vcov = vcovHC(h_m_fix_ef_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years:")
  h_m_fix_ef_f <- plm(formula, data = hitter_remaining,
                      model = "within",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(h_m_fix_ef_f,
                              vcov = vcovHC(h_m_fix_ef_f,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_f)
  
  print("Test:")
  print(phtest(h_m_fix_ef_i,h_m_fix_ef_f))
}
```

### Starting pitcher

```{r starting_stimation_within_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_fielder_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_s  <- paste(vars, stat_fielder_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_s,
                   stat_fielder_t_1[[i]],
                   sep = " + ")
  
  print("First two years:")
  s_m_fix_ef_i <- plm(formula, data = starting_first_two,
                      model = "within",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(s_m_fix_ef_i,
                              vcov = vcovHC(s_m_fix_ef_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years:")
  s_m_fix_ef_f <- plm(formula, data = starting_remaining,
                      model = "within",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(s_m_fix_ef_f,
                            vcov = vcovHC(s_m_fix_ef_f,
                                          type = "HC1",
                                          cluster = "group"))
  print(my_lm_cluster_f)
  
  print("Test:")
  print(phtest(s_m_fix_ef_i,s_m_fix_ef_f))
}
```

## Efectos aleatorios

### Bateadores

```{r hitter_stimation_simple_random_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_hitter_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_h  <- paste(vars, stat_hitter_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_h,
                   stat_hitter_t_1[[i]],
                   sep = " + ")
  
  print("First two years:")
  h_m_random_i <- plm(formula, data = hitter_first_two,
                      model = "random",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(h_m_random_i,
                              vcov = vcovHC(h_m_random_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years:")
  h_m_random_f <- plm(formula, data = hitter_remaining,
                      model = "random",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(h_m_random_f,
                              vcov = vcovHC(h_m_random_f,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_f)
  
  print("Test:")
  print(phtest(h_m_random_i,h_m_random_f))
}
```

### Starting pitcher

```{r starting_stimation_random_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_fielder_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_s  <- paste(vars, stat_fielder_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_s,
                   stat_fielder_t_1[[i]],
                   sep = " + ")
  
  print("First two years:")
  s_m_random_i <- plm(formula, data = starting_first_two,
                      model = "random",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(s_m_random_i,
                              vcov = vcovHC(s_m_random_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years:")
  s_m_random_f <- plm(formula, data = starting_remaining,
                      model = "random",
                      index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(s_m_random_f,
                              vcov = vcovHC(s_m_random_f,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_f)
  
  print("Wu-Haussman test:")
  print(phtest(s_m_random_i,s_m_random_f))
}
```

## First Differences

### Bateadores

Se obtendrán las estimaciones de las variables referentes a estadísticas deportivas sin controles

```{r hitter_stimation_simple_fd_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_hitter_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_h  <- paste(vars, stat_hitter_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_h,
                   stat_hitter_t_1[[i]],
                   sep = " + ")
  
  print("First two years:")
  h_m_first_d_i <- plm(formula, data = hitter_first_two,
                       model = "fd",
                       index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(h_m_first_d_i,
                              vcov = vcovHC(h_m_first_d_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years:")
  h_m_first_d_f <- plm(formula, data = hitter_remaining,
                       model = "fd",
                       index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(h_m_first_d_f,
                              vcov = vcovHC(h_m_first_d_f,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_f)
  
  print("Test:")
  print(phtest(h_m_first_d_i,h_m_first_d_f))
}
```

### Starting pitcher

```{r starting_stimation_fd_ini}
# loop over the variables in var_hitter_list
for (i in 1:length(stat_fielder_t_1)){
  # run linear regression with grouped errors by country and robust errors
  base_vars_s  <- paste(vars, stat_fielder_t[[i]],
                      sep = '+')
  formula <- paste(base_vars_s,
                   stat_fielder_t_1[[i]],
                   sep = " + ")
  
  print("First two years:")
  s_m_first_d_i <- plm(formula, data = starting_first_two,
                       model = "fd",
                       index = c("id", "Anio_ref"))
  
  my_lm_cluster_i <- coeftest(s_m_first_d_i,
                              vcov = vcovHC(s_m_first_d_i,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_i)
  
  print("Remaining years:")
  s_m_first_d_f <- plm(formula, data = starting_remaining,
                       model = "fd",
                       index = c("id", "Anio_ref"))
  
  my_lm_cluster_f <- coeftest(s_m_first_d_f,
                              vcov = vcovHC(s_m_first_d_f,
                                            type = "HC1",
                                            cluster = "group"))
  print(my_lm_cluster_f)
  
  print("Wu Haussman test:")
  print(phtest(s_m_first_d_i,s_m_first_d_f))
}
```

